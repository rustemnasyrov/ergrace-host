# 2. Dynamic Model — расчёт динамики движения лодки и параметров тренировки

## 2.1 Назначение
Модуль Dynamic Model преобразует сырые данные силового и оптического датчиков в физические и тренировочные метрики, необходимые для пользовательской индикации, логики тренировки и передачи по протоколам (CSAFE/FTMS/ANT+). Модель максимально близко воспроизводит алгоритмы Concept2 PM5.

## 2.2 Входные данные
| № | Источник | Параметр | Частота, Гц |
|---|----------|----------|-------------|
| 1 | Force Model | F(t) — мгновенная сила на весле, Н | 50 |
| 2 | Optical Sensor | ω(t) — угловая скорость барабана, рад/с | 1000 → усреднение до 100 |
| 3 | Core Logic | Stroke State (Drive / Recovery) | ивент |
| 4 | User Settings | Масса лодки `m_boat` (кг) | при старте |
| 5 | User Settings | Масса спортсмена `m_rower` (кг) | при старте |
| 6 | Calibration | Drag Factor `DF` (безразм.) | при старте / по запросу |

Общая масса `M = m_boat + m_rower`.

## 2.3 Ключевые параметры и модели
1. Кинематическая модель барабана:
   - Перевод угловой скорости `ω` в линейную скорость лодки `v` через передаточное отношение `k` (м/рад).
2. Аэродинамическое сопротивление эргометра:
   - Уравнение сопротивления: `F_drag = C * v^2`, где `C` вычисляется из Drag Factor `DF` (алгоритм C2).
3. Интегрирование:
   - Ускорение `a = (ΣF - F_drag)/M`.
   - Скорость `v(t+Δt) = v(t) + a * Δt`.
   - Путь `s(t+Δt) = s(t) + v * Δt`.
4. Работа и мощность:
   - Мгновенная мощность `P = F * v`.
   - Работа за ход `W_stroke = ∫ P dt`.
5. Пересчёт PM5-формул:
   - Pace/500 m  `pace = 500 / v` (приведённое время).
   - Watts ↔ Pace: `P = 2.80 / (pace/500)^3` (рекомендация C2).
   - Calories/hour `Cal_hr = 4 * P + 300`.
   - Инкремент калорий `ΔCal = (P * Δt) / 4186`.

## 2.4 Выходные данные
| Группа | Параметр | Частота публикации | Потребитель |
|--------|----------|-------------------|-------------|
| Текущие | Speed `v` (м/с) | 20 Гц | UI, CSAFE, BLE |
|  | Pace/500 m (с) | 20 Гц | UI, CSAFE, BLE |
|  | Power P (Вт) | 20 Гц | UI, CSAFE, ANT+ FE-C |
|  | Calories/hr | 20 Гц | UI |
|  | Stroke Rate SPM | 1 Гц | UI, CSAFE |
| Суммарные | Distance `s` (м) | 20 Гц | UI, логика гонки |
|  | Elapsed Time (с) | 1 Гц | UI, Core Logic |
|  | Total Calories (ккал) | 1 Гц | UI |
|  | Average Pace/Power | 1 Гц | UI, Storage |
| Походовые | Work per Stroke (Дж) | на событие окончания хода | UI (Force curve) |
|  | Drive/Recovery Time (мс) | на событие | UI |
|  | Stroke Distance (м) | на событие | UI, Storage |

## 2.5 Интерфейсы
- **Pub/Sub (ESP-IDF EventLoop)**: публикация структур `dynamic_update_t` каждую 50 мс.
- **RPC (for tests)**: командa `dyn.get_snapshot()` возвращает JSON с последними вычислениями.

## 2.6 Точность и производительность
- Ошибка накопленной дистанции ≤ 0.5 % на 2 км (при скорости 3 м/с).
- Ошибка мощности ≤ 5 Вт при 250 Вт референсе.
- Вычисления выполняются в задачи FreeRTOS (`dyn_task`) с периодом 20 мс, время цикла ≤ 2 мс (на ESP32 240 МГц).

## 2.7 Калибровка
- Drag Factor определяется модулем Force Model в процедуре «Drag Test» (10 с раскрутки).
- Переменные `k` (передаточное отношение) и `C` сохраняются в NVS.

## 2.8 Точки расширения
- Учёт сопротивления воды/ветра для Outdoor-режима.
- Доп. метрики: VO₂ , TRIMP-баллы, Stroke Power Curve Export.

## 2.9 Тестирование
1. HIL-тест с эталонным PM5: отклонение ключевых метрик < 1 %.
2. Юнит-тесты на математические функции (GoogleTest).  
3. Режим симуляции с искусственным Force/Pace для CI. 
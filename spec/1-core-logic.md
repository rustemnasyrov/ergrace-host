# Core Logic — Режимы тренировок и гонок

## Краткая справка по режимам
| Режим | Назначение | Ключевые параметры |
|-------|------------|--------------------|
| **Just Row** | Свободная гребля без заранее заданных целей. | Нет предварительных настроек; данные считаются по ходу сессии. |
| **Single Distance** | Тренировка/гонка на фиксированную дистанцию. | Distance (m), Splits (авто/ручные). |
| **Single Time** | Тренировка на заданное время. | Time (hh:mm:ss), Optional Splits. |
| **Single Calories** | Тренировка, пока не будет сожжено заданное число калорий. | Calories (kcal). |
| **Interval Distance/Time/Calories** | Серия Work/Rest сегментов с фиксированным заданием. | Work Len, Rest Len, Repeats. |
| **Interval Variable** | Последовательность сегментов произвольной длины. | До 50 пар Work/Rest. |
| **Undefined Rest** | Интервалы с паузой произвольной длины. | Work Len, кнопка старта следующего. |
| **Race (ErgRace)** | Синхронизированная гонка с другими гребцами через ErgRace. | Race Distance/Time, Lane №, Sync clock. |

---

## 1. Core Logic — Интервальные тренировки (аналог PM5)

### 1.1. Классификация интервальных занятий
- **Intervals Distance** — фиксированная дистанция «Work» + отдых по времени/дистанции.
- **Intervals Time** — фиксированное время «Work» + отдых.
- **Intervals Calories** — фиксированное количество калорий «Work» + отдых.
- **Intervals Variable** — последовательность отрезков произвольных параметров (до 50), для каждого задаются Work/Rest.
- **Undefined Rest** — отдых с неопределённой длительностью, запускается/останавливается кнопкой; используется, когда паузу задаёт тренер/судья.

### 1.2. Настройка параметров
1. Задаётся параметр Work (дистанция / время / калории).
2. Задаётся параметр Rest (время или дистанция). Для Variable — индивидуально для каждого интервала.
3. Количество повторов (Set) 1…50.
4. Последняя пользовательская программа сохраняется, импорт/экспорт через мобильное приложение или USB.

### 1.3. Поведение во время тренировки
- Экран отображает: номер интервала, обратный отсчёт Work, темп, мощность, SPM, калории/ч.
- По завершении Work звучит сигнал, начинается Rest-фаза; метрики мощности замирают.
- При Rest «undefined» старт следующего Work по нажатию кнопки.
- После последнего Rest тренировка завершается, данные сохраняются в память.

### 1.4. Запись и экспорт данных
- Каждый Work-сегмент сохраняется как отдельный «Split»; Rest фиксируется с нулевой мощностью.
- Stroke-by-stroke данные хранятся (до 30 мин полноценного ряда).
- Экспорт: CSV / FIT / TCX через мобильное приложение или USB OTG.

### 1.5. Протокол CSAFE (PM5_CSAFE)
- **SetWorkout (0xA5)** — передача списка интервалов.
- **Get Workout State (0xA0)** — запрос статуса.
- **Get Stroke Data (0xBF)** — текущие метрики.
- **Status Update (0x80)** — события Start/Stop/IntervalEnd.

### 1.6. Ограничения
- Минимальный Work: 1 м / 10 с / 1 ккал.
- Максимум интервалов: 50.
- Сумма Variable не > 9:59:59 или 99 999 м.
- В режиме гонки используются только Distance / Time.

### 1.7. Требования к реализации
- Поддержка всех типов, включая Undefined Rest (опция).
- Частота обновления логики — 20 Гц.
- События паузы/прерывания, расширяемый список режимов.
- Сохранение в историю: все Work-сегменты + суммарная сессия.
- Интеграция с отображением графиков силы.

## 8. Just Row (Свободная гребля)
### 8.1 Настройка
- Пользователь нажимает «Start» без ввода параметров.
- Логика создаёт сессию с открытым концом; Splits формируются по 1 км или 5 мин по выбору (настройка).

### 8.2 Поведение
- Счётчики Distance, Time и Calories растут вверх.
- Экран показывает текущие метрики: Pace/500 m, Power, SPM, HR.
- Сессию можно поставить на паузу; возобновление — любым гребком.

### 8.3 Запись и экспорт
- Система создаёт Split каждые 1 км/5 мин.
- Сессия сохраняется при нажатии «Stop» или по тайм-ауту бездействия (30 с).

### 8.4 CSAFE
- Workout Type = Just Row (0x20).
- Status Update отправляется при Start/Stop/Pause.

### 8.5 Ограничения
- Максимальная длительность 10 ч или 100 км (ограничение памяти).

---

## 9. Single Distance
### 9.1 Настройка
- Ввод Distance 100 m … 100 000 m.
- Автоматические Splits каждые 500 m, 1 km или пользовательские.

### 9.2 Поведение
- Счётчик Distance ведётся обратным отсчётом.
- При достижении 0 m сессия заканчивается, звучит сигнал.

### 9.3 Запись и экспорт
- Splits формируются по выбранному шагу.
- Экспорт аналогичен Intervals.

### 9.4 CSAFE
- SetWorkout Simple Distance (SubType 0x01).
- Get Workout State отражает Remaining Distance.

### 9.5 Ограничения
- Distance ≤ 100 km.

---

## 10. Single Time
### 10.1 Настройка
- Ввод времени 1 мин … 9 ч 59 м 59 с.
- Авто-Splits каждые 1 мин или пользовательский шаг.

### 10.2 Поведение
- Таймер обратного отсчёта.
- По достижении 00:00:00 — финиш, звуковой сигнал.

### 10.3 Запись и экспорт
- Splits по шагу времени.

### 10.4 CSAFE
- SetWorkout Simple Time (SubType 0x02).

### 10.5 Ограничения
- Не более 9 ч 59 м 59 с.

---

## 11. Single Calories
### 11.1 Настройка
- Задание Calories 1 … 9999 kcal.

### 11.2 Поведение
- Счётчик калорий обратный.
- Distance и Time растут.

### 11.3 Запись и экспорт
- Splits по 50 kcal или пользовательскому шагу.

### 11.4 CSAFE
- SetWorkout Simple Calories (SubType 0x04).

### 11.5 Ограничения
- 9999 kcal максимум.

---

## 12. Race Mode (ErgRace)
### 12.1 Настройка
- Параметры получает через ErgRace: Race Distance/Time, Lane №, Sync-id.
- Core Logic переходит в «Slave» режим синхронизации по стартовому импульсу.

### 12.2 Поведение
- До старта отображается экран ожидания с обратным отсчётом («ATTENTION», «ROW»).
- После старта управление аналогично Single Distance/Time, но время/дистанция приходят от сервера.

### 12.3 Запись и экспорт
- Структура Splits как в гонке PM5 — фиксированные 100 m (или 250 m для длинных дистанций).

### 12.4 CSAFE / IP
- При подключении по RS-485/BLE устройство обменивается командами CSAFE с ErgRace.
- Для Wi-Fi используется TCP прокси (протокол DanteSport-Bridge).

### 12.5 Ограничения
- Поддерживается только Distance/Time гонка. 
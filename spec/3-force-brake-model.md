# 3. Force & Brake Model — сенсоры, тормоз и калибровка

## 3.1 Аппаратные датчики (варианты)
| ID | Датчик | Параметр | Преимущества | Недостатки |
|----|--------|----------|--------------|------------|
| S1 | Оптический энкодер (750 ppr) | Скорость/путь барабана | Простота, высокая частота | Нет прямой силы |
| S2 | Холловский/магн.
энкодер на вале | Дублир. скорость + ускорение | Запасная система, точная dω/dt | Требует магнитной метки |
| S3 | Тензодатчик S-type 50 kg | Тяговая сила цепи | Прямая кривая силы | Установочный узел, цена |
| S4 | Датчик тока катушки (INA219) | Ток → магнитный поток | Нужно для активного тормоза | Погрешность ±1 % |

Датчики S1 + S4 обязательны для катушечного тормоза; S3 и/или S2 — опционально (выбор на этапе прототипа).

## 3.2 Модель тормозного момента
```
M_b(ω, I) = k_I · I · ω      // активная катушка
M_b(ω)    = k_p · ω          // пассивные магниты
```
Константы `k_I`, `k_p` вычисляются экспериментально и хранятся в NVS.

## 3.3 Расчёт силы гребка
1. Считываем ω (S1) и I (S4)  ➜  `M_b`.
2. Считываем `F_chain` (S3) при наличии.
3. Определяем J (момент инерции барабана) в заводской калибровке.
4. В фазе Drive:
```
M_tot = J·dω/dt + M_b
F = (M_tot / r)           // r – радиус барабана
если S3 есть:  F = α·F_chain + β·F   // data fusion
```

## 3.4 Цифровой эквивалент Drag Factor
Вводим величину **MagDrag (MD)** — аналог C2 Drag Factor.
```
MD = 300 · M_b / (ω · r)   // нормирован на скорость 3 m/s
```
Модуль вычисляет MD для каждого Stroke и усредняет за 5 с. Значение выводится на экран и доступно по BLE/CSAFE.

### 3.4.1 Автоподстройка
При ручной регулировке рычага/тока катушки пользователь целится в MD≈130–160 (значения Concept2). UI показывает шкалу.

## 3.5 Процедура калибровки для равенства тренажёров
1. **Coast-down test (без спортсмена)**  
   a) Разогнать барабан до 100 rad/s электромотором (или резким рывком).  
   b) Отключить привод; измерить время падения ω от 100 до 20 rad/s.  
   c) Алгоритм расчёта k_I/k_p по формуле экспоненциального затухания.
2. **Dynamic pull test (со спортсменом)**  
   a) В сервисном меню «Cal Stroke» предлагается выполнить 5 гребков силой ~250 Вт.  
   b) Система сравнивает рассчитанную мощность с эталонной таблицей и подправляет коэффициент α (fusion).
3. **Сравнительная калибровка**  
   a) Один тренажёр выступает эталоном.  
   b) На обоих выполняется автоматический сценарий (моторный привод) с идентичным профилем момента; система минимизирует ∆P среднеквадратичным методом (загрузка коэффициентов).

Результатом является набор коэффициентов `k_I/p`, `J`, `α`, которые обеспечивают совпадение скорости/мощности ±1 % между любыми откалиброванными устройствами.

## 3.6 Выходные данные модуля
| Параметр | Частота | Куда |
|----------|---------|------|
| Instant Force F (Н) | 50 Гц | Dynamic Model, UI |
| Force Curve 256 | на Stroke | UI (график) |
| MagDrag MD | 1 Гц | UI, BLE, CSAFE |
| Brake Torque M_b | 20 Гц | Diagnostics |
| Coil Current I | 10 Гц | Diagnostics |

## 3.7 Требования к точности
- Воспроизводимость MagDrag между тренажёрами: ±2 DF.
- Погрешность силы: ≤5 Н при 300 Н.

## 3.8 Тестирование
- Стендовый coast-down vs Matlab model (R² > 0.98).
- Сличение средней мощности с PM5 при 2 km тесте: ∆P < 3 Вт.
- Клиент ErgRace принимает MagDrag как DF и отображает корректно. 